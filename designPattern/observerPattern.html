<!DOCTYPE <!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>观察者模式</title>
</head>

<body>
    <script>
        /*********
        观察者模式又叫做发布-订阅模式。这是一种一对多的对象依赖关系，当被依赖的对象的状态发生改变时，
        所有依赖于它的对象都将得到通知。
        在JavaScript中观察者模式的实现主要用事件模型。
        例如：document.body.addEventListener("click",function(){});
        ****************/
        //自定义事件
        //商家：发布者
        //客户：订阅者
        // 定义商家
        var merchants = {};
        // 定义预定列表
        merchants.orderList = {};
        // 将增加的预订者添加到预定客户列表中
        merchants.listen = function (id, info) {
            if (!this.orderList[id]) {
                this.orderList[id] = [];
            }
            this.orderList[id].push(info);
            console.log('预定成功');
        };
        //发布消息
        merchants.publish = function () {
            var id = Array.prototype.shift.call(arguments);
            var infos = this.orderList[id];
            // 判断是否有预订信息
            if (!infos || infos.length === 0) {
                console.log('您还没有预订信息!');
                return false;
            }
            // 如果有预订信息，则循环打印
            for (var i = 0, info; info = infos[i++];) {
                console.log('尊敬的客户：');
                info.apply(this, arguments);
                console.log('已经到货了');
            }
        };
        // 定义一个预订者customerA，并指定预定信息
        var customerA = function () {
            console.log('黑色至尊版一台');
        };
        // customerA 预定手机，并留下预约电话
        //merchants.listen('15888888888', customerA); // 预定成功
        // 商家发布通知信息
        //merchants.publish('15888888888');
        /**
           尊敬的客户：
           黑色至尊版一台
           已经到货了
         */
        //取消订阅，将客户从预定列表中删除
        merchants.remove = function (id, fn) {
            var infos = this.orderList[id];

            if (!infos) return false;

            if (!fn) {
                infos && (infos.length = 0);
            } else {
                for (var i = 0, len = infos.length; i < len; i++) {
                    if (infos[i] === fn) {
                        infos.splice(i, 1);
                    }
                }
            }
        };
        //merchants.remove('15888888888', customerA);
        //merchants.publish('15888888888'); // 您还没有预订信息!

        //一道相关测试题
        /*var Event = {
            on: function (eventName, callback) {
                if (!this.events) {
                    this.events = {};
                }
                if (!this.events[eventName]) {
                    this.events[eventName] = [];
                }
                this.events[eventName].push(callback);
            },
            emit: function (eventName) {
                for (var i = 0; i < this.events[eventName].length; i++) {
                    this.events[eventName][i](arguments[1]);
                }
            }
        };
        Event.on('test', function (result) {
            console.log(result);
        });
        Event.on('test', function () {
            console.log('test');
        });
        Event.emit('test', 'hello world'); // 输出 'hello world' 和 'test'*/
        //题目二
        var Event = {
            on: function (eventName, callback) {
                if (!this.events) {
                    this.events = {};
                }
                this.events[eventName] = callback;
            },
            emit: function (eventName) {
                if (this.events[eventName]) {
                    this.events[eventName]();
                }
            }
        };

        var person1 = {};
        var person2 = {};
        Object.assign(person1, Event);
        Object.assign(person2, Event);
        person1.on('call1', function () {
            console.log('person1');
        });
        person2.on('call2', function () {
            console.log('person2');
        });
        person1.emit('call1'); // 输出 'person1'
        person1.emit('call2'); // 没有输出
        person2.emit('call1'); // 没有输出

        //添加一个取消订阅
        person1.remove = function (eventName) {
            delete this.events[eventName];
            
        }
        person1.remove('call1');
        person1.emit('call1');
    </script>
</body>

</html>